<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../static/css/detail.css" />
    <link rel="stylesheet" href="../static/css/detail_review.css" />
    <link rel="stylesheet" href="../static/css/footer.css" />
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>상세페이지</title>
  </head>
  <body>
    <!-- 헤더 삽입 -->
    <header></header>
    <!------------------------------------------------- grid row1 start ------------------------------------------->
    <div class="gridRow1 container">
      <h1>Movie Reviews</h1>

      <div class="reviews">
        <% if (reviews.length === 0) { %>
        <p>No reviews available.</p>
        <% } else { %>
        <ul class="review-list">
          <% for (let i = 0; i < 3; i++) { %>
          <!-- 처음 3개의 데이터만 렌더링 -->
          <li class="review-item">
            <!-- 해당 useridx의 nickname으로 수정 -->
            <span>닉네임: <%= reviews[i].nickname %></span>
            <span><%= reviews[i].description %></span>
            <span>평가: <%= reviews[i].rate %>/5</span>
          </li>
          <% } %>
        </ul>
        <% } %>
      </div>
      <!-- 리뷰 작성 폼 -->
      <div class="starRate">
        <form class="mb-3" name="myform" id="myform" method="post">
          <!-- 별점 남기기 -->
          <fieldset>
            <span class="text-bold">별점을 선택해주세요</span>
            <input type="radio" name="reviewStar" value="5" id="rate1" /><label
              for="rate1"
              onclick="saveRating(5)"
              >★</label
            >
            <input type="radio" name="reviewStar" value="4" id="rate2" /><label
              for="rate2"
              onclick="saveRating(4)"
              >★</label
            >
            <input type="radio" name="reviewStar" value="3" id="rate3" /><label
              for="rate3"
              onclick="saveRating(3)"
              >★</label
            >
            <input type="radio" name="reviewStar" value="2" id="rate4" /><label
              for="rate4"
              onclick="saveRating(2)"
              >★</label
            >
            <input type="radio" name="reviewStar" value="1" id="rate5" /><label
              for="rate5"
              onclick="saveRating(1)"
              >★</label
            >
          </fieldset>
        </form>
      </div>
      <form class="myReview">
        <input type="text" class="writeReview" id="userReview" placeholder="리뷰를 작성해보세요" />
        <button type="button" class="submitReview" onclick="submitReview()">리뷰작성</button>
      </form>
    </div>
    <!--------------------------------- grid row1 end / row2 start ------------------------------------------->
    <div class="gridRow2 container">
      <div class="poster" id="poster_path"></div>
      <div class="rates">
        <div class="movieName" id="title"></div>
        <div class="movieGenre" id="genre"></div>
        <div class="movieRelease_date" id="release_date"></div>
      </div>
      <div class="summaries">
        <div class="movieOverview" id="overview"></div>
      </div>
    </div>
    <!--------------------------------- grid row2 end / row3 start ------------------------------------------->
    <div class="gridRow3 container">
      <div class="alikeMovies">
        <div id="alikeMovieLeft" class="alikeMovie">이 영화와 비슷한 영화 포스터</div>
        <div id="alikeMovieMain" class="alikeMovie">이 영화와 비슷한 영화 포스터</div>
        <div id="alikeMovieRight" class="alikeMovie">이 영화와 비슷한 영화 포스터</div>
      </div>
    </div>
    <footer>
      <div class="footer">
        <strong>주식회사</strong> 무비캐스터 <strong>대표</strong> 4FLEX 서울특별시 용산구 청파로
        109(나진전자월드상가) 3층 <br />
        <strong>사업자 등록 번호</strong> 595-95-0099 <br />
        © 2023 by MovieCaster, Inc. All rights reserved. <br />
      </div>
    </footer>
    <script>
      // ---------------------------------script-----row1 start------------------------------------------
      function saveRating(rate) {
        console.log('나의 평가:', rate);
        window.rating = rate;
      }

      function submitReview() {
        const reviewText = document.getElementById('userReview').value;
        const rating = window.rating;

        // 보낼 데이터 준비
        const reviewData = {
          rating: rating,
          review: reviewText,
        };

        // Axios를 사용하여 데이터를 POST 요청으로 보내기
        axios({
          method: 'post',
          url: '/detail/saveReview', // 실제 서버에 요청을 보내는 엔드포인트 경로를 지정해주세요
          data: reviewData, // 보낼 데이터 객체
        })
          .then((response) => {
            console.log('리뷰가 성공적으로 제출되었습니다:', response.data);

            // 추가된 리뷰 데이터 가져오기
            const newReview = response.data.review;

            // 새로운 리뷰를 첫 번째 항목으로 추가
            const reviewList = document.querySelector('.review-list');
            const newReviewItem = document.createElement('li');
            newReviewItem.classList.add('review-item');
            newReviewItem.innerHTML = `
        <span>닉네임: ${newReview.nickname}</span>
        <span>${newReview.description}</span>
        <span>평가: ${newReview.rate}/5</span>
      `;
            reviewList.insertBefore(newReviewItem, reviewList.firstChild);

            // 기존 첫 번째 리뷰 삭제 (두 번째로 이동)
            if (reviewList.children.length > 3) {
              reviewList.removeChild(reviewList.lastElementChild);
            }
          })
          .catch((error) => {
            console.error('리뷰 제출 중 오류 발생:', error);
            // 오류를 처리합니다 (필요한 경우)
          });
      }
      // --------------------------------------------row1 end / row2 start---------------------------------------

      document.addEventListener('DOMContentLoaded', () => {
        // 페이지가 로드되면 서버로부터 영화 정보를 가져옵니다.
        axios({
          method: 'get',
          url: '/detail/getMovieInfo',
        })
          .then((response) => {
            const movieInfo = response.data;
            // 받은 데이터를 이용하여 화면에 표시하거나 다른 작업을 수행할 수 있습니다.
            updateMovieInfo(movieInfo);
          })
          .catch((error) => {
            console.error('Error fetching movie information:', error);
            // 오류 처리
          });
      });

      function updateMovieInfo(movieInfo) {
        // 받아온 영화 정보를 화면에 표시하는 함수
        document.getElementById(
          'poster_path'
        ).innerHTML = `<img src="${movieInfo.poster_path}" alt="포스터" />`;
        document.getElementById('title').innerHTML = `제목: ${movieInfo.title}`;
        document.getElementById('genre').innerHTML = `장르: ${movieInfo.genre}`;
        document.getElementById('release_date').innerHTML = `개봉일: ${movieInfo.release_date}`;
        document.getElementById('overview').innerHTML = `영화 줄거리: ${movieInfo.overview}`;
      }
    </script>
  </body>
</html>
